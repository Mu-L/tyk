---
version: '3'

vars:
  COMPOSE_FILE: ci/integration/redis/docker-compose.yml

tasks:
  default:
    desc: Run redis storage integration tests
    cmds:
      - task: up
      - task: test
      - task: down
    silent: true

  test:
    silent: true
    desc: Run redis storage integration tests (no environment)
    dir: storage/internal
    cmds:
      - go test -tags=integration -v -race -coverprofile=coverage.out -cover -coverpkg=./... ./...

  up:
    silent: true
    desc: Run integration test services
    preconditions:
      - sh: docker compose version --short | grep '^2'
        msg: 'docker compose v2 is expected to be installed'
    cmds:
      - docker compose -f {{.COMPOSE_FILE}} up -d --wait

  down:
    silent: true
    desc: Shutdown integration test services
    cmds:
      - docker compose -f {{.COMPOSE_FILE}} stop -t 0
      - docker compose -f {{.COMPOSE_FILE}} down --remove-orphans
